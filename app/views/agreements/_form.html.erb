<script type="text/javascript">
  <% a = Hash.new
     Category.select("id, name, parent_id").each {|c| a[c.id] = c } %>
     window.categories = <%= raw(a.to_json(:methods => %w(option_children option_products))) %>;
  <% a = Hash.new
     Product.select("id, name, category_id").each {|p| a[p.id] = p} %>
     window.products = <%= raw(a.to_json) %>;
     console.log(window.categories);
</script>
<%= form_for(@agreement, html: { multipart: true, class: "form-horizontal" }) do |f| %>
  
<legend></legend>
<%= render partial: 'partials/errors', locals: {obj: @agreement} %>

<div class="row">
  <div class="span12"><h2>Two Methods:</h2></div>
  <div class="span6">
    <h4>1. Quick-select system!</h4>
    <div class="control-group">
      <label class="req control-label" for="agreement_product_id">Product:</label>
      <div class="controls controls-row">
	<%= f.select :product_id, option_groups_from_collection_for_select(Category.includes(:products).order('name'), :products, :name, :id, :name, (@agreement.new_record? ? (params[:product_id].blank? ? "" : params[:product_id]) : @agreement.product.id)), {prompt: "-- Please type and select --"}, {class: "select2 span4" } %>
      </div>
    </div>

    <div class="control-group">
      <%= f.label :name, "Title:", class: "control-label" %>
      <div class="controls controls-row">
	<%= f.text_field :name, class: "span4" %>
	<span class="help-inline">Further differentiate <%= current_user.producer? ? "your product" : "your proposal" %>.</span>
      </div>
    </div>

    <%= f.fields_for :images do |fi| %>
      <%= render partial: "agreements/image", locals: {f: fi} %>
    <% end %>

    <div class="control-group">
      <%= f.label :description, "Description:", class: "control-label" %>
      <div class="controls controls-row">
	<%= f.text_area :description, rows: 4, class: "span4" %>
	<span class="help-inline">(optional) Add a detailed description or custom instructions<%= current_user.producer? ? "." : " for what you are looking for." %></span>
      </div>
    </div>

    <% if current_user.producer? %>
    <div class="control-group">
      <%= f.label :locally_packaged, "Locally Packaged:", class: "control-label" %>
      <div class="controls control-row">
	<label class="checkbox"><%= f.check_box :locally_packaged %> Check this box if this product locally packaged, but not grown or raised locally.</label>
      </div>
    </div>
    <% end %>
  </div>

  <div class="span6">
    <h4>2. Browse the product tree.</h4>
    <div class="control-group">
      <label class="control-label">Category:</label>
      <div class="controls controls-row">
	<%= select_tag "category_id", options_from_collection_for_select(Category.roots, :id, :name), {prompt: "-- Please select --", class: "span4" } %>
      </div>
    </div>
    <div class="control-group">
      <label class="control-label">Sub-category:</label>
      <div class="controls controls-row">
	<%= select_tag "subcategory_id", options_from_collection_for_select(Category.leaves, :id, :name), {prompt: "-- Please select --", disabled: true, class: "span4" } %>
      </div>
    </div>
    <div class="control-group">
      <label class="control-label">Product:</label>
      <div class="controls controls-row">
	<%= select_tag "fake_product_id", options_from_collection_for_select(Product.all, :id, :name), {prompt: "-- Please select --", disabled: true, class: "span4" } %>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="span12">
    <p><br /></p>
    <legend>Preferred Partners</legend>
    <p>List preferred <%= current_user.buyer? ? "producers" : "buyers" %> below. They will be notified and have 3 days to respond before your proposal becomes public.</p>
    [TODO]
  </div>
</div>

<% if params["agreement_type"] == "onetime" %>
<div class="row">
  <div class="span12">
    <legend>Pricing Options</legend>
    <%= f.hidden_field :agreement_type, value: "onetime" %>
    <%= f.hidden_field :start_date, value: Date.today %>
  </div>
  <div class="span6">
    <div class="control-group">
      <%= f.label :selling_unit, "Selling Unit:", class: "control-label" %>
      <div class="controls controls-row">
	<%= f.select :selling_unit, UNIT_TYPE.map {|u| [u.second, u.first]}, {prompt: "-- Please select --"}, {class: "span3"} %>
      </div>
    </div>

    <div class="control-group">
      <%= f.label :price, "Price Per Unit:", class: "control-label" %>
      <div class="controls controls-row">
	<div class="input-prepend">
	  <span class="add-on">$</span>
	  <%= f.text_field :price, placeholder: "0.00", class: "span2" %>
	</div>
	<span class="help-inline">Unit selected above</span>
      </div>
    </div>

    <div class="control-group">
      <%= f.label :quantity, "Quantity:", class: "control-label" %>
      <div class="controls controls-row">
 	<div class="input-append">
	  <%= f.text_field :quantity, placeholder: "0", class: "span2" %>
	  <span class="add-on" id="quantity_add_on"></span>
	</div>
	<span class="help-inline">Number of units <%= current_user.buyer? ? "demanded" : "available" %></span>
      </div>
    </div>
  </div>
</div>
<% else %>
<div class="row">
  <div class="span12">
    <p><br /></p>
    <legend>Agreement Options</legend>
  </div>

  <div class="span12">
    <p><em>LocalCycle</em> gives you the ability to propose <em>one-time</em>, repeating <em>seasonal</em>, or repeating <em>indefinite</em> contract periods for your agreement.<br />
      (Repeating deliveries can occur with <em>weekly</em> or <em>monthly</em> frequency.)</p>
    <div class="control-group">
      <%= f.label :agreement_type, "Agreement Type:", class: "control-label" %>
      <div class="controls controls-row">
	<%= f.select :agreement_type, AGREEMENT_TYPES.map {|u| [u.second, u.first]}, {prompt: "-- Please select --"}, {class: "span4"} %>
      </div>
    </div>
  </div>
 
  <div class="span6">
    <div class="dfagreement_agreement_type dfindefinite dfseasonal dfonetime">
      <div class="control-group">
	<%= f.label :selling_unit, "Selling Unit:", class: "control-label" %>
	<div class="controls controls-row">
	  <%= f.select :selling_unit, UNIT_TYPE.map {|u| [u.second, u.first]}, {prompt: "-- Please select --"}, {class: "span3"} %>
	</div>
      </div>

      <div class="control-group">
	<%= f.label :price, "Price Per Unit:", class: "control-label" %>
	<div class="controls controls-row">
	  <div class="input-prepend">
	    <span class="add-on">$</span>
	    <%= f.text_field :price, placeholder: "0.00", class: "span2" %>
	  </div>
	  <span class="help-inline">Unit selected above</span>
	</div>
      </div>

      <div class="control-group">
	<%= f.label :quantity, "Quantity:", class: "control-label" %>
	<div class="controls controls-row">
 	  <div class="input-append">
	    <%= f.text_field :quantity, placeholder: "0", class: "span2" %>
	    <span class="add-on" id="quantity_add_on"></span>
	  </div>
	  <span class="help-inline">Number of units <%= current_user.buyer? ? "demanded" : "available" %> <span class="dfagreement_frequency dfweekly">(per weekly delivery)</span><span class="dfagreement_frequency dfmonthly">(per monthly delivery)</span></span>
	</div>
      </div>
    </div>
  </div>

  <div class="span6">
    <div class="dfagreement_agreement_type dfindefinite dfseasonal">
      <div class="control-group">
	<%= f.label :frequency, "Frequency:", class: "control-label" %>
	<div class="controls controls-row">
	  <%= f.select :frequency, FREQUENCIES.map {|u| [u.second, u.first]}, {prompt: "-- Please select --"}, {class: "span4"} %>
	</div>
      </div>
    </div>
    <div class="dfagreement_agreement_type dfseasonal dfonetime">
      <div class="control-group">
	<%= f.label :start_date, "Begin Date:", class: "control-label" %>
	<div class="controls controls-row controls-date">
	  <%= f.text_field :start_date, data: {behavior: "datepicker"} %>
	  <span class="help-inline dfagreement_agreement_type dfseasonal">First week of agreement period</span>
	  <span class="help-inline dfagreement_agreement_type dfonetime">On what date <%= current_user.producer? ? "will your product be available?" : "is this product is needed?" %></span>
	</div>
      </div>    
    </div>
    <div class="dfagreement_agreement_type dfseasonal">
      <div class="control-group">
	<%= f.label :end_date, "End Date:", class: "control-label" %>
	<div class="controls controls-row controls-date">
	  <%= f.text_field :end_date, data: {behavior: "datepicker"} %>
	  <%#= f.date_select :end_date, :prompt => true, :order => [:month, :day, :year] %>
	  <span class="help-inline">Last week of agreement period</span>
	</div>
      </div>
    </div>
  </div>
</div>
<% end %>


<div class="row">
  <div class="span12">
    <p><br /></p>
    <legend>Delivery Options</legend>
    <p>Use your default delivery options below OR <%= link_to "Customize", "#" %></p>
    <% if current_user.producer? %>    
    <% elsif current_user.buyer? %>
    <% end %>
    [TODO]
  </div>
</div>

<hr style="clear: both;" />
  
  <%= render partial: 'partials/submit', locals: {f: f, override: (params["agreement_type"] == "onetime") ? 'Post Product Supply' : 'Post Agreement' } %>

<% end %>
