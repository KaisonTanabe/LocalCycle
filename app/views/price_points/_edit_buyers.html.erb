<% json  = (@data == 'undefined') ? Hash.new : ActiveSupport::JSON.decode(@data)  %>
<legend>Select Buyers/Markets </legend>
<%= form_tag do %>
	<span id="modal_form_data">
		<% if current_user.admin?%>
			<% networks = Network.all%>
		<% elsif @good == nil %>
			<%networks= current_user.networks%>
		<%else%>
			<% networks = @good.markets.map{|m| m.network}.uniq%>
		<%end%>
		<% networks.each do |n|%>
			<h4 <%= "style = 'display:none'" if !current_user.networks.include?(n) && !current_user.admin?%> ><%= n.name%></h4>
				<% #current_user.markets.where(:network_id => n.id).each do |market|%>

				<% n.markets.each do |market|%>
						<div class="row-fluid " <%= " style=visibility:hidden;height:0px !important;" if !current_user.markets.include?(market) && !current_user.admin?%>>
				
							<div class="span12 well" <%= " style=visibility:hidden;height:0px !important;" if !current_user.markets.include?(market) && !current_user.admin?%>>					
								<h5> <%= check_box_tag :market_flag, market.id, json[market.id.to_s] != nil && json[market.id.to_s].count == 0 %><%=market.name%></h5>
								<div class="row-fluid">
									<div class="span1"></div>
								<% market.buyers.each do |buyer|%>
										<div class="span3">
											<%= check_box_tag :buyer_flag, buyer.id, json[market.id.to_s] != nil && json[market.id.to_s].include?(buyer.id.to_s) %><%="#{buyer.first_name} #{buyer.last_name}"%>
										</div>
								<%end%>
								</div>
								<div class="row-fluid">
									<div class="button_bar span12"> 
										 <div class="btn btn-primary btn-small select_all">Select All</div> <div class="btn btn-primary btn-small select_none">Select None</div>
									</div>
					
								</div>
				
							</div>
						</div>
				<%end%>
		<%end%>
			
	
		</div>
		<br/>
		<%= submit_tag "Update Buyers", :class=> "btn btn-primary update_buyers", :data =>{:target => @target_id}%>
	</span>
	
<%end%>